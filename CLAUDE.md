# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## What is Briefflow

Briefflow is a personal newsletter triage and reading tool. It connects to Gmail via OAuth, lets the user triage newsletters (keep/skip), then generates AI-summarized "editions" displayed as a newspaper-style grid. Single-user app.

**Core flow:** Gmail OAuth → Session → Triage (keep/skip) → Generate Edition (Gemini) → Read Newspaper

## Commands

```bash
npm run dev              # Start dev server (localhost:3000)
npm run build            # Production build
npm run lint             # ESLint
npm run test             # Vitest (single run)
npm run test:watch       # Vitest (watch mode)
npm run db:generate      # Generate Drizzle migrations from schema changes
npm run db:migrate       # Apply migrations (tsx src/db/migrate.ts)
npm run db:studio        # Drizzle Studio (DB web UI)
npm run db:seed          # Seed database
```

Run a single test file: `npx vitest run src/__tests__/example.test.ts`

## Tech Stack

- **Framework:** Next.js 16 (App Router) + React 19 + TypeScript
- **Styling:** Tailwind CSS 4 + shadcn/ui + Framer Motion
- **Database:** SQLite (better-sqlite3) + Drizzle ORM
- **AI:** Google Gemini (`@google/genai`) for newsletter summarization
- **Gmail:** `googleapis` for OAuth and email fetching
- **HTML parsing:** `@mozilla/readability` + `jsdom`
- **Testing:** Vitest

## Architecture

### Route Groups

- `src/app/(app)/` — Protected routes (triage, read, stats). Require valid session.
- `src/app/onboarding/` — 3-step guided flow (Connect → Label → Triage).
- `src/app/api/` — API routes (auth, newsletters, editions, labels, preferences, stats).
- `src/app/page.tsx` — Public landing page.

### Auth

Session-based auth using Google OAuth 2.0. Cookie `briefflow-session` (HTTP-only, 30-day expiry). Tokens stored in `user_tokens` table. Middleware (`src/middleware.ts`) protects all routes except `/`, `/api/auth`, `/api/auth/callback`.

- `src/lib/session.ts` — Session CRUD
- `src/lib/auth-helpers.ts` — Session retrieval utilities
- `src/lib/gmail.ts` — OAuth client setup

### Database

SQLite file `briefflow.db` at project root. 8 tables defined in `src/db/schema.ts`. Drizzle ORM for type-safe queries. Migrations in `drizzle/` (auto-generated by `drizzle-kit generate`).

Key tables: `newsletters`, `triageDecisions`, `editions`, `editionArticles`, `sessions`, `userTokens`, `userPreferences`, `readingSessions`.

### Key Modules

- `src/lib/newsletters.ts` — Gmail integration (fetch, parse HTML with Readability, mark read, label management)
- `src/lib/summarize.ts` — Gemini API calls with exponential backoff for rate limits
- `src/components/newspaper-card.tsx` — Hero and standard article cards for edition display
- `src/components/triage-card.tsx` — Newsletter triage card (swipe/keyboard interactions)
- `src/components/article-overlay.tsx` — Slide-over panel for full article reading

### Path Alias

`@/*` maps to `./src/*` (configured in tsconfig.json and vitest.config.ts).

## Environment Variables

Required in `.env` (see `.env.example`):

| Variable | Purpose |
|----------|---------|
| `GOOGLE_CLIENT_ID` | Google OAuth credentials |
| `GOOGLE_CLIENT_SECRET` | Google OAuth credentials |
| `GOOGLE_REDIRECT_URI` | OAuth callback (default: `http://localhost:3000/api/auth/callback`) |
| `GEMINI_API_KEY` | Google Gemini API key for summarization |

## Design Documents

Architecture and UX decisions are documented in `docs/plans/`. Consult these before making significant changes to understand the rationale behind current design choices.
